<!DOCTYPE html>
<html> 
<head> 
	<title>Simple Example</title> 
    <link rel="stylesheet" href="js/jquery-ui-1.11.3/jquery-ui.css" />
	
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script> 
	<script src="js/three.min.js"></script>
	<script src="js/GSVPano.js"></script>
	<script src="js/Hyperlapse.js"></script>
    <script src="js/jquery.js"></script>
	<script src="js/underscore.js"></script>
    
    <script src="js/jquery-ui-1.11.3/jquery-ui.min.js"></script>
	<script src="js/moment-with-locales.min.js"></script>
	<script>
        

$(function () {
    function createHyperlapse(locations) {
		$("#pano").html("");
	
		if (locations.length < 2) {
			alert("too few location points (count: "+locations.length+") for the day");
			return;
		} else if (locations.length > 10) {
			alert("too many location points (count: "+locations.length+") for the day. only showing first 10");
			locations = locations.slice(0, 10);
		}
		
		var hyperlapse = new Hyperlapse(document.getElementById('pano'), {
			//lookat: new google.maps.LatLng(41.842085, -71.394373),//(37.81409525128964,-122.4775045005249),
			zoom: 2,
			use_lookat: false,
			elevation: 50,
			width: 1200,
			height: 600,
			millis: 1000/24,
			distance_between_points: 3,
			max_points: 50
		});

		hyperlapse.onError = function(e) {
			console.log(e);
		};

		hyperlapse.onRouteComplete = function(e) {
			hyperlapse.load();
		};

		hyperlapse.onLoadComplete = function(e) {
			hyperlapse.play(); //adding slider instead.
			$("#slider").attr("min", 0);
			$("#slider").attr("max", hyperlapse.getPositionCount()-1);
			$("#slider").val(0);
			$("#slider").show();
			//hyperlapse.setPosition(0);
			$("#slider").on("input", function(){
				var sliderPos = parseInt($("#slider").val());
				//console.log(sliderPos);
				hyperlapse.setPosition(sliderPos);
			});
		};
		
		var first = locations.shift()
		var last = locations.pop()
		
		// Google Maps API stuff here...
		var directions_service = new google.maps.DirectionsService();

		var route = {
			request:{
				origin: googleLatLng(first),//(37.816480000000006,-122.47825,37),
				destination: googleLatLng(last),//(37.81195,-122.47773000000001),
				waypoints: _(locations).map(function(location) { 
					return {
						location: googleLatLng(location)
					};
				}),
				travelMode: google.maps.DirectionsTravelMode.DRIVING
			}
		};

		directions_service.route(route.request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				hyperlapse.generate( {route:response} );
			} else {
				console.log(status);
			}
		});
	}
	
	function googleLatLng(location) {
		return new google.maps.LatLng(location.latitude, location.longitude);
	}
	
	$( "#datePicker" ).datepicker({
		onSelect: function(dateText, inst) { 
			var dateAsString = dateText; //the first parameter of this function
			var dateAsObject = $(this).datepicker( 'getDate' ); //the getDate method
			$( "#date" ).text(dateAsString);
			var locations = getLocationsOnDate(dateAsString);
			createHyperlapse(locations);
		}
	});
	
	var fileInput = document.getElementById('fileInput');

	fileInput.addEventListener('change', function(e) {
		var file = fileInput.files[0];

		var reader = new FileReader();
		
		reader.readAsText(file);

		reader.addEventListener('load', function(e) {
			processLocationExport(reader.result);
		});
	});
	
	var dateGrouppedLocations = null;
	
	function processLocationExport(fileContents){
		dateGrouppedLocations = parseLocationJson(fileContents);
		$("#datePicker").show();
		//var urls = generateStreetViewUrls(locations, false);
		//var urls = generateStreetViewUrls(locations, true);
	}
	
	function getLocationsOnDate(date) {
		var locationHtml = "";
		
		var locations = dateGrouppedLocations[date];
		locations.sort(function(a, b) {
			return a.milis - b.milis;
		});
		
		var uniqLocations = []
		var uniq = {}
		
		locations.forEach(function(location, i){
			var date = location.milis;
			// always get up to the first 7 digits after decimal
			var lat = (""+location.latitude).match(/^(.+\.\d{1,7})/)[1];
			var lon = (""+location.longitude).match(/^(.+\.\d{1,7})/)[1];
		

			// location unique to 3 digits after decimal point
			var latSig = (""+lat).match(/^(.+\.\d{1,3})/)[1];
			var lonSig = (""+lon).match(/^(.+\.\d{1,3})/)[1];
			var key = latSig + "_" + lonSig;
			
			if (uniq[key]) {
				return;
			} else {
				uniq[key] = true;
			}
			
			//locationHtml += "Date:" + moment(date).format("MM/DD/YYYY H:mm:ss") + " Lat:" + lat + " Lon:" + lon + "\n";
			uniqLocations.push(location);
		});
		
		
		//$("#urlList").html("<pre>"+locationHtml+"</pre>")
		return uniqLocations;
	}

	function generateStreetViewUrls(locations, uniq){
		var urls = [];
		var uniq = {}
		
		locations.forEach(function(location, i){
			// always get up to the first 7 digits after decimal
			var lat = (""+location.latitude).match(/^(.+\.\d{1,7})/)[1];
			var lon = (""+location.longitude).match(/^(.+\.\d{1,7})/)[1];
		
			if (uniq) {
				// location unique to 3 digits after decimal point
				var latSig = (""+lat).match(/^(.+\.\d{1,3})/)[1];
				var lonSig = (""+lon).match(/^(.+\.\d{1,3})/)[1];
				var key = latSig + "_" + lonSig;
				
				if (uniq[key]) {
					return;
				} else {
					uniq[key] = true;
				}
			}
		
			var streetViewUrl = "https://maps.googleapis.com/maps/api/streetview?size=600x600&location=" + lat + "," + lon +"&fov=90&heading=270&pitch=10";
			urls.push(streetViewUrl);
			
			if (Math.random() > 0.99) console.log("Gen URLs: " + i/locations.length*100 + "%");
		});
		
		return urls;
	}

	function parseLocationJson(locJson) {
		var obj = JSON.parse(locJson);
		var results = {};
		
		obj.locations.forEach(function(location, i){
			if (i % 1000 == 0) {
				console.log("Parsing: " + i + "/" + obj.locations.length);
			}

			if (location.accuracy > 10) return;
			
			var lat = location.latitudeE7 * 0.0000001;
			var lon = location.longitudeE7 * 0.0000001;
			//console.log("Latitude: " + lat + "    Longitude: " + lon);
			
			//time checks
			var timeMs = parseInt(location.timestampMs);
			var date = moment(timeMs).format("MM/DD/YYYY");
			if(!results[date]) {
				results[date] = [];
			}
			results[date].push({latitude: lat, longitude: lon, milis: timeMs});
						
			//if (Math.random() > 0.99) 
		});
		
		return results;
	};

});
		
	</script> 
</head> 
<body> 
    <div id="pano"></div>
	<input id="slider" type="range" name="points" min="0" max="10" style="width:1200px; display:none;">
	<div id="calendar">
	    <form>
			<legend>Pick a date:</legend>
			<input id="datePicker" style="display:none;"/>
	    </form>
		<p id="date"/>
	</div>
	<br>
	<div id="page-wrapper">
		<h1>Json File Reader</h1>
		<div>
			Select a json file: 
			<input type="file" id="fileInput">
		</div>
		<br>
		<div id="loadProg"></div>
		<div id="parseProg"></div>
		<br>
		<h3>Streetview URLs:</h3>
		<div id="urlList"></div>
	</div>
</body> 
</html>