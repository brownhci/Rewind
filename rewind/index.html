<!DOCTYPE html>
<html> 
<head> 
	<title>A trip down the memory lane...</title> 
    <link rel="stylesheet" href="js/jquery-ui-1.11.3/jquery-ui.css" />
	
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script> 
	<script src="js/three.min.js"></script>
	<script src="js/GSVPano.js"></script>
	<script src="js/Hyperlapse.js"></script>
    <script src="js/jquery.js"></script>
	<script src="js/underscore.js"></script>
    
    <script src="js/jquery-ui-1.11.3/jquery-ui.min.js"></script>
	<script src="js/moment-with-locales.min.js"></script>
	<script>
        

$(function () {
    function createHyperlapse(locations, pano) {
    	var panoWidth = 1200;
    	var panoHeight = 600;

		$(pano).html("");
	
		if (locations.length < 2) {
			alert("too few location points (count: "+locations.length+") for the day");
			return;
		} else if (locations.length > 10) {
			// alert("too many location points (count: "+locations.length+") for the day. only showing first 10");
			locations = locations.slice(0, 10);
		}
		
		var hyperlapse = new Hyperlapse(pano, {
			//lookat: new google.maps.LatLng(41.842085, -71.394373),//(37.81409525128964,-122.4775045005249),
			zoom: 2,
			use_lookat: false,
			elevation: 50,
			width: panoWidth,
			height: panoHeight,
			millis: 1000/24,
			distance_between_points: 1,
			max_points: 20
		});

		hyperlapse.onError = function(e) {
			console.log(e);
		};

		hyperlapse.onRouteComplete = function(e) {
			hyperlapse.load();
		};

		hyperlapse.onLoadComplete = function(e) {
			hyperlapse.play(); //adding slider instead.
			$("#slider").attr("min", 0);
			$("#slider").attr("max", hyperlapse.getPositionCount()-1);
			$("#slider").val(0);
			$("#slider").show();
			//hyperlapse.setPosition(0);
			$("#slider").on("input", function(){
				var sliderPos = parseInt($("#slider").val());
				//console.log(sliderPos);
				hyperlapse.setPosition(sliderPos);
			});
			//when cursor is on rewind video
			$(pano).on( "mousemove", function(event){
				var mouseX = parseInt(event.pageX - parseInt($(pano).offset().left));
                var mouseY = parseInt(event.pageY - parseInt($(pano).offset().top));
                console.log( "pageX: " + mouseX + ", pageY: " + mouseY );
                var imagePos = parseInt(mouseX * (hyperlapse.getPositionCount()-1) / panoWidth);
				console.log(imagePos);
				hyperlapse.setPosition(imagePos);
			});
		};
		
		var first = locations.shift()
		var last = locations.pop()
		
		// Google Maps API stuff here...
		var directions_service = new google.maps.DirectionsService();

		var route = {
			request:{
				origin: googleLatLng(first),//(37.816480000000006,-122.47825,37),
				destination: googleLatLng(last),//(37.81195,-122.47773000000001),
				waypoints: _(locations).map(function(location) { 
					return {
						location: googleLatLng(location)
					};
				}),
				travelMode: google.maps.DirectionsTravelMode.DRIVING
			}
		};

		directions_service.route(route.request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				hyperlapse.generate( {route:response} );
			} else {
				console.log(status);
			}
		});
	}
	
	function googleLatLng(location) {
		return new google.maps.LatLng(location.latitude, location.longitude);
	}
	
	// $( "#datePicker" ).datepicker({
	// 	onSelect: function(dateText, inst) { 
	// 		var dateAsString = dateText; //the first parameter of this function
	// 		var dateAsObject = $(this).datepicker( 'getDate' ); //the getDate method
	// 		$( "#date" ).text(dateAsString);
	// 		var locations = getLocationsOnDate(dateAsString);
	// 		createHyperlapse(locations);
	// 	},

	// 	beforeShowDay: function(date) {
	// 		console.log(date);
	// 		var formattedDate = moment(date).format("MM/DD/YYYY");
	// 		var enabled = locationsByDate[formattedDate] ? true : false;
	// 		return [enabled, "", ""];
	// 	}
	// });
	
	var fileInput = document.getElementById('fileInput');

	fileInput.addEventListener('change', function(e) {
		var file = fileInput.files[0];

		var reader = new FileReader();
		
		reader.readAsText(file);

		reader.addEventListener('load', function(e) {
			processLocationExport(reader.result);
		});
	});
	
	var locationsByDate = null;

	function getRandomLocations(locationsByDate, count){
		var randLocations = [];
		var i = 0;
		var dates = _.keys(locationsByDate);
		while (i<count) {
			var date = dates[Math.floor(Math.random()*dates.length)];
			var dateLocations = getLocationsOnDate(date);

			if (dateLocations.length > 2){
				var location = dateLocations[Math.floor(Math.random()*dateLocations.length)];
				randLocations.push({date: date, location: location});
				i++;
			}
		}
		return randLocations;
	}

	function processLocationExport(fileContents){
		locationsByDate = parseLocationJson(fileContents);
		var imageIndex = 0;
		var imageCount = 10;
		var locations = getRandomLocations(locationsByDate, imageCount);
		//var urls = generateStreetViewUrls(locations, false);
		var flatLocations = _.pluck(locations, "location");
		
		// making this true filters the flatLocations array, filtering similar locations. 
		// Cannot match dates with locations in this case. urls does not match flatLocations.
		var urls = generateStreetViewUrls(flatLocations, false); 

		var questionsHtml = "";

		var questionHtmlTpl = "" +
			"<div class='location-questions' id='q{{INDEX}}'>" +
				"<div class='image-pano'><img src='{{SRC}}' data-date='{{DATE}}'></img></div>" +
				"<ol>" +
					"<li class='question'>" +
						"<div class='qtext'> Do you remember this place?</div>" +
						"<div class='qanswers'>" +
							"<input type='radio' name='q{{INDEX}}ans1' value='true'></input> Yes" +
							"<input type='radio' name='q{{INDEX}}ans1' value='false'></input> No" +
						"</div>" +
					"</li>" +
					"<li class='question'>" +
						"<div class='qtext'> Is this an important place to you?</div>" +
						"<div class='qanswers'>" +
							"<input type='radio' name='q{{INDEX}}ans2' value='true'></input> Yes" +
							"<input type='radio' name='q{{INDEX}}ans2' value='false'></input> No" +
						"</div>" +
					"</li>" +
					"<li class='question'>" +
						"<div class='qtext'> Do you want to keep this picture?</div>" +
						"<div class='qanswers'>" +
							"<input type='radio' name='q{{INDEX}}ans3' value='true'></input> Yes" +
							"<input type='radio' name='q{{INDEX}}ans3' value='false'></input> No" +
						"</div>" +
					"</li>" +
					"<li class='question' style='display:none'>" +
						"<div class='qtext'> Were you traveling alone?</div>" +
						"<div class='qanswers'>" +
							"<input type='radio' name='q{{INDEX}}ans4' value='true'></input> Yes" +
							"<input type='radio' name='q{{INDEX}}ans4' value='false'></input> No" +
						"</div>" +
					"</li>" +
				"</ol>" +
			"</div>";

		
		urls.forEach(function(url, i) {
	//		questionsHtml += "<a href='"+url+"'>"+url+"</a><br/>";
			var questionHtml = questionHtmlTpl
				.replace("{{SRC}}", url)
				.replace(/{{INDEX}}/g, i)
				.replace("{{DATE}}", locations[i].date);
			
			questionsHtml += questionHtml;
		});

		
		var $resDiv = $("#questionList");
		$resDiv.html(questionsHtml);

		$(".image-pano > img").click(function () {
			//alert($(this).attr("data-date"));
			var locations = getLocationsOnDate($(this).attr("data-date"));
			createHyperlapse(locations, this.parentNode);
		});

		$(".location-questions > ol > li:first-child input").change(function () {
			if (this.value == "true") {
				$(this.parentNode.parentNode.parentNode).find("li").show();
			}
		});

		$(".location-questions").each(function () {
		    $(this).hide();
		});
	    
		$("#q0").show();
		$("#nextButton").show();

		$("#submitButton").click(function () {
			var questions = $(".location-questions");
			var answers = [];

			questions.each(function(i, locQuestion) {
				var url = $(locQuestion).find("img").attr("src");
				var questions = $(locQuestion).find(".question");

				var answer = {
					"url": url,
					"q1": $(questions[0]).find("input:checked").attr("value") || null,
					"q2": $(questions[1]).find("input:checked").attr("value") || null,
					"q3": $(questions[2]).find("input:checked").attr("value") || null,
				};

				answers.push(answer);
			});

			console.log(answers);

			yesCounter = 0;
			answers.forEach(function (answer) {
				if (answer["q1"] == "true")
					yesCounter++;
			});
			alert("You remember " + yesCounter + " our of " + answers.length + " places");
		});
		$("#nextButton").click(function (){
			$("#submitButton").show();
			$("#backButton").show();
			if (imageIndex < imageCount -1 ){
				$("#q" + imageIndex).hide();
	            imageIndex++;
	        }
	        if (imageIndex == imageCount -1 ){
	            $("#nextButton").hide();
	        }
	        $("#q" + imageIndex).show();
	        console.log("Showing: #q" + imageIndex + " imageIndex: " + imageIndex + " imageCount: " + imageCount);
		});
		$("#backButton").click(function (){
			$("#nextButton").show();
			$("#submitButton").show();
			if (imageIndex > 0){
			    imageIndex--;
			}
			if (imageIndex == 0){
	            $("#backButton").hide();
			}
			$("#q" + (imageIndex + 1)).hide();
			$("#q" + imageIndex).show();
	        console.log("Showing: #q" + imageIndex + " imageIndex: " + imageIndex + " imageCount: " + imageCount);

		});
	}
	
	function getLocationsOnDate(date) {
		var locationHtml = "";
		
		var locations = locationsByDate[date];
		locations.sort(function(a, b) {
			return a.milis - b.milis;
		});
		
		var uniqLocations = []
		var uniq = {}
		
		locations.forEach(function(location, i){
			var date = location.milis;
			// always get up to the first 7 digits after decimal
			var lat = (""+location.latitude).match(/^(.+\.\d{1,7})/)[1];
			var lon = (""+location.longitude).match(/^(.+\.\d{1,7})/)[1];
		

			// location unique to 3 digits after decimal point
			var latSig = (""+lat).match(/^(.+\.\d{1,3})/)[1];
			var lonSig = (""+lon).match(/^(.+\.\d{1,3})/)[1];
			var key = latSig + "_" + lonSig;
			
			if (uniq[key]) {
				return;
			} else {
				uniq[key] = true;
			}
			
			//locationHtml += "Date:" + moment(date).format("MM/DD/YYYY H:mm:ss") + " Lat:" + lat + " Lon:" + lon + "\n";
			uniqLocations.push(location);
		});
		
		
		//$("#urlList").html("<pre>"+locationHtml+"</pre>")
		return uniqLocations;
	}

	function generateStreetViewUrls(locations, uniq){
		var urls = [];
		var uniq = {}
		
		locations.forEach(function(location, i){
			// always get up to the first 7 digits after decimal
			var lat = (""+location.latitude).match(/^(.+\.\d{1,7})/)[1];
			var lon = (""+location.longitude).match(/^(.+\.\d{1,7})/)[1];
		
			if (uniq) {
				// location unique to 3 digits after decimal point
				var latSig = (""+lat).match(/^(.+\.\d{1,3})/)[1];
				var lonSig = (""+lon).match(/^(.+\.\d{1,3})/)[1];
				var key = latSig + "_" + lonSig;
				
				if (uniq[key]) {
					return;
				} else {
					uniq[key] = true;
				}
			}
		
			var streetViewUrl = "https://maps.googleapis.com/maps/api/streetview?size=600x600&location=" + lat + "," + lon +"&fov=90&heading=270&pitch=10";
			urls.push(streetViewUrl);
			
			if (Math.random() > 0.99) console.log("Gen URLs: " + i/locations.length*100 + "%");
		});
		
		return urls;
	}

	function parseLocationJson(locJson) {
		var obj = JSON.parse(locJson);
		var results = {};
		
		obj.locations.forEach(function(location, i){
			if (i % 1000 == 0) {
				console.log("Parsing: " + i + "/" + obj.locations.length);
			}

			if (location.accuracy > 10) return;
			
			var lat = location.latitudeE7 * 0.0000001;
			var lon = location.longitudeE7 * 0.0000001;
			//console.log("Latitude: " + lat + "    Longitude: " + lon);
			
			//time checks
			var timeMs = parseInt(location.timestampMs);
			var date = moment(timeMs).format("MM/DD/YYYY");
			if(!results[date]) {
				results[date] = [];
			}
			results[date].push({latitude: lat, longitude: lon, milis: timeMs});
						
			//if (Math.random() > 0.99) 
		});
		
		return results;
	};

});
		
	</script>
</head> 
<body>
	<h1>How much do you remember?</h1> 
	<div id="page-wrapper">
		Select a json file: 
		<input type="file" id="fileInput">
	</div>
	<br>
	<div>
		<br>
		<div id="loadProg"></div>
		<div id="parseProg"></div>
		<br>
		<h3></h3>
		<div id="questionList"></div>
		<button id="backButton" style="display:none">Back</button>
		<button id="nextButton" style="display:none">Next</button>
		<button id="submitButton" style="display:none">Submit</button>
	</div>
    <div id="pano"></div>
</body> 
</html>
